---
title       : Apache Cassandra
author      : Alberto Díaz Álvarez <alberto.diaz@upm.es>
description : >
  Las bases de datos clave-valor son un tipo de sistemas de gestión de bases de
  datos NoSQL que almacena y recupera datos como un par de clave-valor. Cada
  valor se almacena en la base de datos asociado a una clave única, la cual es
  utilizada para identificar y recuperar el valor correspondiente. Estas bases
  de datos son muy sencillas y eficientes, ya que sólo requieren de operaciones
  básicas como obtener o establecer el valor de una clave. Además, son altamente
  escalables y tolerantes a fallos, lo que las hace adecuadas para aplicaciones
  de alta disponibilidad y rendimiento. Ejemplos de bases de datos clave-valor
  son Redis, Riak, Amazon DynamoDB y Apache Cassandra.
marp        : true
paginate    : true
theme       : bbdd
---

<!-- _class: titlepage -->

# Introducción

## Apache Cassandra - Bases de datos II

### Alberto Díaz Álvarez (<small><alberto.díaz@upm.es></small>)

#### Departamento de Sistemas Informáticos

##### Escuela Técnica superior de Ingeniería de Sistemas Informáticos

[![height:30](https://img.shields.io/badge/License-CC%20BY--NC--SA%204.0-informational.svg)](https://creativecommons.org/licenses/by-nc-sa/4.0/)

---

En este tema hablaremos de las bases de datos clave-valor

- Sus propiedades, escalabilidad, indexación, etcétera
- Nos centraremos en Apache Cassandra, aunque sea un modelo clave-valor híbrido
  - Híbrido porque incluye el concepto de columnas

Su _paper_ de referencia:

- Lakshman, A., & Malik, P. (2010). **Cassandra: a decentralized structured storage system**. _ACM SIGOPS_ operating systems review, 44(2), 35-40.

---

# Bases de datos clave-valor<!-- _class: section -->

---

# ¿Qué es una base de datos clave-valor?

Es un sistema que almacena valores indexados por claves

- Vamos, como una tabla _hash_, pero a lo bestia
- Permite almacenar datos estructurados y no estructurados

---

<!-- _class: cite -->

<div class="cite-author" data-text="Cassandra: The definitive guide (J. Carpenter y E. Hewitt">

   _"Apache Cassandra is an **open source**, **distributed**, **decentralized**, **elastically scalable**, **highly available**, **fault-tolerant**, **tunable** and **consistent** database that bases its distribution design on Amazon's Dynamo and its data model on Google's Bigtable. Created at Facebook, it is now used at some of the most popular sites on the web."_

</div>

---

# Sobre Apache Cassandra

Sistema de gestión de bases de datos **NoSQL distribuido**

- Arrancado por Facebook y posteriormente cedido a la [Apache Foundation](https://cassandra.apache.org/)
- Gratuito y de código abierto (licenciado bajo la [Apache License 2.0](https://www.apache.org/licenses/LICENSE-2.0))
- Desarrollado en el lenguaje de programación Java y multiplataforma
- Diseñado para manejar grandes cantidades de datos entre muchos nodos
- Soporta clústeres distribuidos en diferentes clústeres
- Además con replicación asíncrona sin nodo maestro
- Esto permite operaciones de baja latencia
- Web: <https://cassandra.apache.org>
- Algunos sitios que usan Cassandra: [Netflix](https://netflixtechblog.com/tagged/cassandra), [Spotify](https://engineering.atspotify.com/tag/apache-cassandra/) y [Uber](http://highscalability.com/blog/2016/9/28/how-uber-manages-a-million-writes-per-second-using-mesos-and.html)

<!-- Libro muy bueno: Cassandra: the Definitive Guide -->

---

# Su sitio en la familia NoSQL

Las bases de datos NoSQL suelen estar orientadas a casos muy específicos

- Vamos a compararla con MongoDB

<div class="columns">
<div class="column">

##### MongoDB

Orientado a problemas de **búsqueda** mediante lectura indexada

- P.ej. Sitios de _eCommerce_

Foco: **Consistencia**

Arquitectura: Nodos _main-secondary_

</div>
<div class="column">

##### Apache Cassandra

Almacenamiento rápido y disponibilidad inmediata

- P.ej. Spotify o Netflix

Foco **Escalabilidad** y **disponibilidad**

Arquitectura: _peer-to-peer_

</div>
</div>

---

# Algunas ventajas de cassandra

Desarrollado directamente para ser un servidor **distribuido** y **descentralizado**

- Con soporte para distribución a lo largo de múltiples centros de datos

Lectura y escritura rápida sin afectar al servicio

Escalabilidad horizonal, permitiendo añadir nuevo hardware bajo demanda

- Alta disponibilidad sin punto único de fallo (SPOF, de _single point of failure_)
- Básicamente todo nodo del clúster conoce al resto

API simple para el acceso desde cualquier lenguaje de programación

---

# Y algunas desventajas, claro

Las consultas sobre el sistema son _ad hoc_

- Se modela sobre las consultas a realizar, no sobre la estructura de los datos

No soporta agregaciones como parte del modelo subyacente

- No usan el álgebra relacional, donde las agregaciones son naturales
- Esto es, las operaciones (AVG, MAX, MIN, SUM) son **MUY** costosas

Rendimiento impredecible

- Ejecuta por debajo muchos procesos asíncronos y tareas de segundo plano
- Esto se traduce en un rendimiento impredecible

---

# NO ES UN REEMPLAZO DIRECTO DE BASES DE DATOS RELACIONALES

Existen sitios donde se afirma esto de Apache Cassandra

- La principal causa: El lenguaje de consultas CQL

Sin embargo, no es cierto debido, principalmente, a tres factores:

1. No existe el concepto de **integridad referencia** (nada de _joins_)
1. El soporte a consultas agregadas es limitado
1. El soporte a transacciones es **muy** limitado

Al combinar con [Apache Spark](https://spark.apache.org/), se consiguen suplir los dos primeros puntos

---

# ¿Dónde usar Apache Cassandra?

Sistemas en el que las escrituras superan a las lecturas

- Almacenamiento de todas las peticiones realizadas a un sitio web

Cuando queremos, principalmente, añadir datos y no actualizar o borrar

Cuando nuestro acceso a datos se peude resumir a consultas por clave

- Esto permite que los datos se puedan particionar según la clave
- Y así, se pueden distribuir entre los nodos de un clúster

Cuando no necesitamos hacer _joins_ o agregaciones

---

# Ejemplos

Algunos ejemplos relacionados con aplicaciones web

- Actualización de datos provenientes de múltiples sensores
- Almacenamiento de transacciones comerciales
- Autenticación de usuarios
- Estado de las transacciones, los pedidos, etc.
- Interacciones con el sitio (clicks, votaciones, etc.)
- Monitorización de logs de acceso a sistemas
- Almacenamniento de perfiles de usuarios
- Tracking de actividad de usuarios en el sitio web

---

# Sobre el consistencia, la disponibilidad y la tolerancia a fallos<!-- _class: section -->

---

# Teorema de Brewer

Establece que un sistema sólo puede garantizar a la vez dos requisitos entre:

- **Consistencia**: Toda lectura recibe la escritura más reciente o un error.
- **Disponibilidad**: Toda solicitud recibe una respuesta (no error)
- **Tolerancia al particionado**: Funcionamiento a pesar de pérdida de mensajes

Conocido también como **Teorema CAP** (_**C**onsistency_, _**A**vailability_, _**P**artition tolerance_)

---

# Teorema de Brewer

<center>
<img style="width:70%;height:100%;" src="https://data-science-blog.com/wp-content/uploads/2021/09/cap-theorem-venn-diagram-nosql-sql-databases.png" />
</center>

---

# Teorema de Brewer y Cassandra

Desde un punto de vista práctico, la tolerancia a la partición es necesaria

- Los fallos en red son una constante en nuestra profesión
- Por ello las bases de datos suelen ser CP o AP

Cassandra es un sistema AP, es decir, prioriza disponibilidad sobre consistencia

- Esto es simplificar mucho, en realidad busca satisfacer los tres requisitos
- De hecho se puede configurar para que se comporte muy parecido a CP

Según la [Apache Software Foundation](https://www.apache.org/), ofrece una **consistencia ajustable** de ms.

---

# Garantizando la disponibilidad de los datos

La disponibilidad se garantiza a través de las réplicas

- Cuando se escribe un dato, se escribe en varias réplicas
- Generalmente tres, aunque este parámetro es configurable
- Así nos aseguramos de que si cae un nodo los datos no se pierden

Las réplicas demoran la escritura

- Hay momentos en los que diferentes nodos tienen diferentes valores
- Casandra se describe como **eventualmente consistente** por esto mismo

Es decir, se garantiza la disponibilidad de lso datos, pero no a su última versión

---

# Consistencia "ajustable"

Cassandra permite "ajustar" el nivel $N$ de consistencia (incluso por operación)

- $N \rightarrow$ **¿Cuántas réplicas** deben responder para completar una operación?

Por ejemplo, supongamos que queremos leer datos en un clúster de tres nodos

- El nivel **ONE** devolverá el valor de la **primera** réplica que responda
- El nivel **TWO** devolverá el valor de las **primeras dos** réplicas que respondan
- El nivel **THREE** o QUORUM esperará a que **todas** las réplicas respondan
- ¿Inconsistencias entre réplicas? Cassandra las gestiona antes
- **CUIDADO**: Si no se puede escribir en todas las réplicas, la operación fallará
- **CUIDADO**: Una mayor consistencia afectará significativamente al rendimiento

El **mismo proceso** se aplica a las **operaciones de escritura**

---

# Sistema distribuido y descentralizado<!-- _class: section -->

---

# Distribuido y descentralizado

Prácticamente todas las bases de datos NoSQL son distribuidas

- Ahora bien, que sean distribuidas **Y** descentralizadas no es nada común

¿Qué es cada cosa?

- **Distribuido**: Los clústers pueden funcionar en diferentes máquinas mostrándose como un único sistema al exterior
- **Descentralizado**: Todo nodo es idéntico en responsabilidades, es decir, no hay nodos primarios o secundarios.

La comunicación entre nodos se realiza mediante _peer_to_peer_ usando un protocolo denominado _gossip_

---

# Algunos conceptos de Cassandra<!-- _class: section -->

---

# Columna (_column_)

La unidad básica de almacenamiento

- Es una tupla que contiene un nombre, un valor y un _timestamp_
- Se pueden agrupar en súpercolumnas, familias de columnas y _keyspaces_
- Son análogas a las columnas de una tabla en el modelo relacional

<center><img src="images/t4/column.svg" /></center>

El _timestamp_ indica el momento de la última actualización de la columna

---

# Súpercolumna (_super column_)

Array ordenado de columnas

- Se compone de una clave (_row key_), un nombre y su conjunto de columnas

<center><img src="images/t4/supercolumn.svg" /></center>

---

# Familia de columnas (_column family_)

Agrupación de columnas o súper-columnas que comparten una clave común

- Conjunto de pares clave-valor donde el valor es una lista de nombres de columnas

<center><img src="images/t4/column-family.png" /></center>

Aunque gestione columnas y familias de columnas **no es una bbdd columnar**

---

# Clúster

Conjunto de nodos que componen una instancia de Cassandra

---

# _Keyspaces_ (I)

Son contenedores que almacenan los datos que usa la aplicación

- Esquema de alto nivel que **contiene familias de columnas**
  - Debe haber al menos una familia de columnas por espacio de claves

Análogos a una base de datos en el modelo relacional (pero claro, sin relaciones)

Requieren una configuración de atributos relacionados con la consistencia:

- **Factor de replicación**: Cuánto mejorar la coherencia a cosa del rendimiento
- **Estrategia de ubicación de réplica**: Cómo se colocan las réplicas (`SimpleCategory`, `OldNetwork` `TopologyStrategy` y `NetworkTopologyStrategy`)

<!-- Mirar https://answers.oreilly.com/topic/2408-replica-placement-strategies-when-using-cassandra/ -->

---

# _Keyspaces_ (y II)

Familia de supercolumnas para `user_status`

<center><img src="images/t4/keyspace-supercolumns-family-user-status.svg" /></center>

Familia de columnas para `user_timeline`

<center><img src="images/t4/keyspace-column-family-timeline.svg" /></center>

---

# Cassandra Query Language (CQL)<!-- _class: section -->

---

# CQL

Cassandra tiene como lenguaje de consulta el Cassandra Query Language (CQL)

- Es un lenguaje de consulta de alto nivel, muy similar a SQL
  - Los datos se almacenan en tablas que contienen filas de valores
  - Por ello la terminología (tabla, fila y columna) es la misma en CQL

Algunas características:

- Tipos de datos y operadores aritméticos
- DDL y DML
- Índices secundarios
- Vistas materializadas
- Funciones y triggers

---

# Ejemplo de CQL

```cql
cqlshj> CREATGE KEYSPACE test WITH REPLICATION = {
  'class': 'SimpleStrategy',
  'replication_factor': 1
  };
cqlshj> USE test;
cqlshj> CREATE TABLE users (
  user_id int PRIMARY KEY,
  name text,
  age int);
cqlshj> INSERT INTO users (user_id, name, age) VALUES (1, 'John', 35);
cqlshj> CREATE INDEX ON users (age);
cqlshj> SELECT * FROM users WHERE age = 35;
```

<!-- Echar un ojo a https://github.com/twissandra/twissandra/ 
Es un proyecto donde enseñan cómo funciona cassandra a partir de un proyecto similar a twitter
-->

---

# Gracias<!-- _class: section -->
