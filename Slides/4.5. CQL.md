---
title       : Apache Cassandra - SQL
author      : Alberto Díaz Álvarez <alberto.diaz@upm.es>
description : >
  TBD
marp        : true
paginate    : true
theme       : bbdd
---

<!-- _class: titlepage -->

# CQL (_Cassandra Query Language_)

## Apache Cassandra - Bases de datos II

### Alberto Díaz Álvarez (<small><alberto.díaz@upm.es></small>)

#### Departamento de Sistemas Informáticos

##### Escuela Técnica superior de Ingeniería de Sistemas Informáticos

[![height:30](https://img.shields.io/badge/License-CC%20BY--NC--SA%204.0-informational.svg)](https://creativecommons.org/licenses/by-nc-sa/4.0/)

---

# Cassandra Query Language (CQL)

Es el lenguaje principal de comunicación con clústers de Cassandra

- Su sintaxis es muy intuitiva, similar a SQL
- Pero no tiene gramática para caracteristicas relacionales, como los `join`

```sql
CREATE KEYSPACE nombre_del_keyspace ...
DROP KEYSPACE nombre_del_keyspace;
CREATE TABLE nombre_de_la_tabla ...
TRUNCATE TABLE nombre_de_la_tabla;
DROP TABLE nombre_de_la_tabla;
INSERT INTO nombre_de_la_tabla ...
UPDATE nombre_de_la_tabla SET ...
DELETE FROM nombre_de_la_tabla WHERE ...
// Y más ...
```

---

# Características de CQL

Es case-insensitive; por ejemplo, `SELECT` es lo mismo que `select`

- Lo mismo con los indicadores
- De hecho da igual cómo los creemos, CQL los almacena en minúsculas
- **Excepto** en los identificadores que se enmarcan entre dobles comillas
  - `tabla` es igual que `TABLA`, pero `"tabla"` es diferente de `"TABLA"`

Los comentarios se preceden de `//`

---

# ¿Cómo ejecutamos queries?

Podemos ejecutarlas programáticamente desde un _driver_ cliente

- Por ejemplo, desde Python o Java (Datastax Java Driver, el de por defecto)

También desde su _shell_, denominada cqlsh (_Cassandra Query Language Shell_)

- Viene de serie con cualquier paquete que instalemos de Cassandra
- Está desarrollado en Python
- Se conecta a un nodo del clúster y ejecuta las queries que le pasemos
  - Si no se especifica, se conecta al nodo local (el de por defecto)

Usar editores propietarios o de terceros

- Por ejemplo, [DataStax Studio](https://docs.datastax.com/en/studio/6.8/studio/aboutStudio.html)

---

# `cqlsh`

```bash
$ cqlsh [options] [host [port]]
```

- `options` son opciones que incluyen, entre otras:
  - `--help`: La ayuda, que incluye todas las opciones disponibles
  - `--version`: La versión de `cqlsh`
  - `-u` y `-p`: El usuario y la contraseña
  - `-k`: El `keyspace` a usar
  - `-f`: El fichero de queries a ejecutar
  - `--request-timeout`: El timeout de las queries

---

# Comandos especiales

- `CAPTURE`: Captura la salida de la query en un fichero (no sobrescribe, añade)
- `CONSISTENCY`: Muestra el nivel de consistencia y permite cambiarlo
- `COPY`: Importación y exportación de datos
- `DESCRIBE`: Muestra información sobre el clúster, `keyspace`, tablas, etc.
- `EXIT`: Sale de `cqlsh`
- `PAGING`: Activa o desactiva la paginación en los resultados de las consultas
- `TRACING`: Activa o desactiva las trazas de las consultas

---

# Consistencia "ajustable"

`CONSISTENCY` permite "ajustar" el nivel de consistencia por operación

- **¿Cuántas réplicas** deben responder para aceptar una operación?
  - `ONE`, `TWO` y `THREE`: Al menos una, dos y tres réplicas, respectivamente
  - `QUORUM`: La mayoría de las réplicas del clúster
  - `ALL`: Todas las réplicas
  - `LOCAL_*`: Limita la respuesta a las réplicas del datacenter local

¿Y si existen inconsistencias entre réplicas? Se resuelven durante las lecturas

- **CUIDADO**: Una mayor consistencia afectará significativamente al rendimiento

Un proceso similar se realiza durante las **operaciones de escritura**

- **CUIDADO**: Si no se puede escribir en todas las réplicas, la operación fallará

---

# Comando `COPY`

Permite importar datos desde ficheros CSV

```sql
COPY tabla (columna1, columna2, ...) FROM 'fichero.csv' WITH DELIMITER = ',' AND HEADER = TRUE;
```

También permite la exportación de datos a ficheros CSV

```sql
COPY tabla (columna1, columna2, ...) TO 'fichero.csv' WITH DELIMITER = ',' AND HEADER = TRUE;
```

**CUIDADO**: No es lo más recomendable para la carga o volcado de datos masivos

---

# Identificadores y palabras clave<!-- _class: section -->

---

# Comandos shell<!-- _class: section -->

---

# Manipulación de datos CQL<!-- _class: section -->

---

# Tipos de datos CQL<!-- _class: section -->

---

# Funciones<!-- _class: section -->

---

# Funciones definidas por el usuario<!-- _class: section -->

---

# Colecciones<!-- _class: section -->

---

# Tipos de datos definidos por el usuario<!-- _class: section -->

---

# Seguridad y roles<!-- _class: section -->

---

# Gracias<!-- _class: section -->
